---
title: LIN

categories: 
  - 嵌入式
tags:
  - 通信协议
---



# 参考链接

[LIN入门 (renesas.cn)](https://www.renesas.cn/zh/document/apn/lin?language=zh)

# 概述

LIN 具有以下特点： 

1. 网络由一个主机节点和多个从机节点构成。
2. 使用 LIN 可以大幅度的削减成本，表现在以下方面： 
   1. 开放型规范：规范可以免费从官方网站获得。
   2. 硬件成本削减：基于普通 UART/SCI 接口的低成本硬件实现，无需单独的硬件模块支持；从机节点无需 高精度时钟就可以完成自同步；总线为一根单线电缆。
   3. 装配成本削减：LIN 采用了工作流(Work Flow)和现成节点(Off-the-shelf Node)的概念，将网络装配标准 化，并可通过 LIN 传输层进行再配置。 
   4. 缩短软件开发周期：LIN 协议将 API(Application Programming Interface，应用编程接口)标准化。
3. 信号传输具有确定性，传播时间可以提前计算出。
4. LIN 具有可预测的 EMC(ElectroMagnetic Compatibility，电磁兼容性)性能，。为了限制 EMI(ElectroMagnetic Interference，电磁干扰)强度，LIN 协议规定最大位速率为 20kbps。
5. LIN 提供信号处理、配置、识别和诊断四项功能。

由于 LIN 网络在汽车中一般不独立存在，经常与上层网络(如 CAN)相连，因此子网的概念是相对于上层 网络而言。在不强调与上层网络相连的情况下，后面也称作 LIN 网络。 

![LIN与上层网络连接](https://gitee.com/you-trust-me/pictures/raw/master/Images/image-20260108084705765.png)

一个节点不一定对应一个 ECU(Electronic Control Unit，电子控制单元)，因为一个 ECU 可能提供多个 LIN 接口，并且这些接口可能连接到不同的 LIN 通信子网中。

节点应用层向下层传输信号和消息。信号和消息位于帧中的数据段，是节点向其他节点传达的实质信息。 它们之间的区别在于信号封装于信号携带帧 (帧 ID 范围在 0x00～0x3B 之间)中，用于在运 行状态传递上层发生的事件，如温度传感器的测量结果等。消息封装于诊断帧(帧 ID 为 0x3C 或 0x3D)中，是有固定格式、最大长度不超过 4095 字节的信息。

![LIN节点构成](https://gitee.com/you-trust-me/pictures/raw/master/Images/image-20260108084907437.png)



LIN 的拓扑结构为单线总线，应用了单一主机多从机的概念。总线电平为 12V，传输位速率(Bitrate)最高为 20kbps。由于物理层限制，一个 LIN 网络最多可以连接 16 个节点，典型应用一般都在 12 个节点以下，主机节 点有且只有一个，从机节点有 1 到 15 个。 主机节点(Master Node)包含主机任务(Master Task)和从机任务(Slave Task)，从机节点(Slave Node)只包含从 机任务。

![image-20260108090334726](https://gitee.com/you-trust-me/pictures/raw/master/Images/image-20260108090334726.png)



主机任务负责：

1. 调度总线上帧的传输次序；
2. 监测数据，处理错误； 
3. 作为标准时钟参考；
4. 接收从机节点发出的总线唤醒命令。 

从机任务不能够主动发送数据，需要接收主机发送的帧头(帧的起始部分)，根据帧头 所包含的信息(这里指帧 ID)判断： 

1. 发送应答(帧中除帧头外剩下的部分)； 
2. 接收应答； 
3. 既不接收也不发送应答。

# 协议层

## 帧结构

帧(Frame)包含帧头(Header)和应答(Response)两部分。主机任务负责发送帧头；从机任务接收帧头并对帧头 所包含信息进行解析，然后决定是发送应答，还是接收应答，还是不作任何反应。帧在总线上的传输为：

![帧在总线上的传输](https://gitee.com/you-trust-me/pictures/raw/master/Images/image-20260108091117140.png)

帧头包括：

1. 同步间隔段
2. 同步段
3. PID(Protected Identifier，受保护ID)段

应答包括：

1. 数据段
2. 校验和段

![帧的结构](https://gitee.com/you-trust-me/pictures/raw/master/Images/image-20260108091418511.png)

其中**值“0”为显性电平(Dominant)，值“1”为隐性电平(Recessive)**，总线上实行“线-与”：当总线上有 大于等于一个节点发送显性电平时，总线呈显性电平；所有的节点都发送隐性电平或不发送信息(不发送任何信 息时总线默认呈隐性电平)时，总线才呈现隐性电平，即显性电平起主导作用。图中帧间隔为帧之间的间隔；应 答间隔为帧头和应答之间的间隔；字节间间隔包括同步段和受保护ID段之间的间隔、数据段各字节间之间的间 隔以及数据段最后一个字节和校验和段之间的间隔。



### 同步间隔段

同步间隔段由同步间隔(Break)和同步间隔段间隔符(Break Delimiter)构成。同步间隔是至少持续 13 位(以主机节点的位速率为准)的显性电平，由于帧中的所有间隔或总线空闲时都应保持隐性电平，并 且帧中的任何其它字段都不会发出大于 9 位的显性电平，因此同步间隔可以标志一个帧的开始。同步间隔段的 间隔符是至少持续 1 位的隐性电平。

![同步间隔段](https://gitee.com/you-trust-me/pictures/raw/master/Images/image-20260108092349987.png)

从机任务接收帧头的同步间隔段时，以该从机任务所在节点的位速率为准，当检测总线上出现持续 11 位的显性电平时，认为是帧的开始。当从机节点使用精度较高的时钟时，识别阈值可以选择 9.5 位。 协议没有规定同步间隔段的发送和检测方法。

> [!note]
>
> 需要注意的是：
>
> 1. 发送显性电平的下限为 13 位，上限应保证帧的最大传输时间THeader_Maximum在规定范围之内。 
> 2. 当从机节点选择的时钟(精度不高的时钟)在容限范围内(±14%)时，$(13 - 11.18) / 13  = 14%$，即是说当处于最差情况下(时钟相差 14%)时，从机任务按照自身时钟测量的主机节点发送的 13 位显性电平不会低于 11.18 位，若识别阈值高于 11.18 位，那么当选用 14%的时钟时，就会出现主机发 送同步间隔，而从机检测不到的情形。由于在除同步间隔段以外，帧中任何其余部分都不会发送超过 9 位的显性电平，$(10.26 - 9) / 9 = 14%，$，即是说判断阈值必须大于 10.26 位，否则可能把帧中其余部分误判作为同步间隔段。综上，识别阈值为 11 位显性电平。
> 3. 当从机节点选择的时钟(精度较高的时钟)在容限范围内(±1. 5%)时，识别阈值应在 9.135 位(由$(9.135 - 9) / 9 = 1.5%$计算而来)到 12.805 位(由($13 – 12.805) / 13 =  1.5%$计算而来)之间。具体设定阈值会随着所选时钟的精度，取值范围在 9.135 位到 12.805 位之间浮动。

### 同步段

在介绍同步段之前，首先介绍一下字节域(Byte Field)的概念，字节域包括 **1 位起始位(Start Bit，显性) + 8 位数据位 + 1 位停止位(Stop Bit，隐性)**，是一种标准 UART 数据传输格式。在 LIN 的一帧当中， 除了同步间隔段，后面的各段都是通过字节域的格式传输的。在 LIN 帧中，数据传输都是先发送 LSB(Least Significant Bit，最低有效位)，最后发送 MSB(Most Significant Bit，最高有效位)。

![字节域](https://gitee.com/you-trust-me/pictures/raw/master/Images/image-20260108093817341.png)

LIN 同步以下降沿为判断标志，采用字节 0x55(转换为二进制为 01010101b)。同步段的字节域如下：

![同步段](https://gitee.com/you-trust-me/pictures/raw/master/Images/image-20260108094032452.png)

从机节点可以不采用精度高的时钟，而采用片上振荡器等精度和成本相对较低的时钟，由此带来的与主机节点时钟产生的偏差，需要通过同步段进行调整，调整的结果是使从机节点数据的位速率与主机节点一致。同步段用于同步的基准时钟为主机节点的时钟。从机节点通过接收主机节点发出的同步段，计算出主机节点位速率，根据计算结果对自身的位速率重新作调整。计算公式如下：
$$
1\text{位时间}=\frac{\text{第7位的下降沿时刻 }-\text{起始位的下降沿时刻}}8
$$
通过计算，可以得到主机节点实际传输 1 位所用的时间，即位速率。



### 受保护ID段

受保护ID段的前6位叫作帧 ID(Frame ID)，加上两个奇偶校验位后称作受保护 ID。

![受保护ID段](https://gitee.com/you-trust-me/pictures/raw/master/Images/image-20260108094459917.png)

帧 ID 的范围在 0x00～0x3F 之间，共 64 个。帧 ID 标识了帧的类别和目的地。从机任务对于帧头作出的反应(接收/发送/忽略应答部分)都是依据帧 ID 判断的。如果帧 ID 传输错误，将会导致信号无法正确到达目的地， 因此引入奇偶校验位。校验公式如下，其中“⊕”代表“异或”运算，“¬”代表“取非”运算。
$$
\begin{aligned}
	&\mathrm{
		P0 = IDO\oplus ID1\oplus ID2\oplus ID4
	}\\
	&\mathrm{
		P1=
	}\neg\left(\mathrm{ID1}\oplus\mathrm{ID3}\oplus\mathrm{ID4}\oplus\mathrm{ID5}\right)
\end{aligned}
$$
由公式可以看出，PID 不会出现全 0 或全 1 的情况，因此，如果从机节点收到了“0xFF”或“0x00”，可判断为传输错误。 依据帧 ID 不同将帧进行分类：

| 帧的类型   | ==         | 帧ID       |
| ---------- | ---------- | ---------- |
| 信号携带帧 | 无条件帧   | 0x00～0x3B |
| ：         | 事件触发帧 | ：         |
| ：         | 偶发帧     | ：         |
| 诊断帧     | 主机请求帧 | 0x3C       |
| ：         | 从机应答帧 | 0x3D       |
| 保留帧     | ==         | 0x3E，0x3F |

注意：从机应答帧是一个完整的帧，与帧结构中的“应答”(帧的一部分)不同，注意区别

### 数据段

节点发送的数据位于数据段，包含 1 到 8 个字节，先发送编号最低的字节 DATA1，编号依次增加。 数据段包含了两种数据类型：

1. 信号(Signal)

    信号(Signal)由信号携带帧传递，一个帧 ID 对应的数据段可能包含一个或多个信号。信号更新时要保证其完整性，不能只更新一部分。一个信号通常由一个固定的节点发出，此节点称为该信号的发布节点(Publisher)； 其余的一个或多个节点接收，它们称为信号的收听节点(Subscriber)。 

   > [!tip]
   >
   > 协议没有规定帧中的哪一部分显示数据长度码的信息，**数据的内容和长度是由系统设计者根据帧 ID事先约定好的**。
   >
   > 总线上的数据是以广播形式被发送到总线上的，任何节点均能接收，但并非所有信号对每个节点都有用。 收听节点接收帧的应答是因为该节点的应用层会使用这些信号，而对于其余节点，由于用不到这些信号， 所以没有必要作接收处理，将忽略帧的应答部分。发布和收听由哪个节点进行完全根据应用层的需要由 软件或配置工具实现。一般情况下，对于一个帧中的应答，总线上只存在一个发布节点，否则就会出现 错误。事件触发帧例外，可能存在零个、一个或多个发布节点。

2. 诊断消息(Diagnostic messages)。

   诊断消息(Diagnostic message)由诊断帧传递，对消息内容的解析由数据自身和节点状态决定。

![数据段](https://gitee.com/you-trust-me/pictures/raw/master/Images/image-20260108095807522.png)

















